<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kamerainspeksjonsrapporter</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Toast Notification Container -->
    <div id="toastContainer" class="toast-container"></div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p class="loading-text" id="loadingText">Importerer...</p>
            <p class="loading-subtext" id="loadingSubtext">Vennligst vent</p>
        </div>
    </div>
    
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1>Kamerainspeksjonsrapporter</h1>
                <div style="display: flex; gap: 10px; margin-left: auto;">
                    <button id="settingsBtn" class="btn btn-secondary">‚öôÔ∏è Innstillinger</button>
                </div>
            </div>
            <nav id="breadcrumb" class="breadcrumb"></nav>
        </header>

        <main>
            <!-- Projects List View -->
            <div id="projectsView" class="view active">
                <div class="section-header">
                    <h2>Prosjekter</h2>
                    <div style="display: flex; gap: 10px;">
                        <button id="importProjectBtn" class="btn btn-secondary">üì• Importer prosjekt</button>
                        <button id="newProjectBtn" class="btn btn-primary">+ Nytt prosjekt</button>
                    </div>
                </div>
                <div id="projectsList" class="projects-list"></div>
                <input type="file" id="importProjectFile" accept=".zip" style="display: none;">
            </div>

            <!-- Packages List View -->
            <div id="packagesView" class="view">
                <div class="section-header">
                    <button id="backToProjectsBtn" class="btn btn-secondary">‚Üê Tilbake til prosjekter</button>
                    <h2 id="projectTitle">Testpakker</h2>
                    <div style="display: flex; gap: 10px;">
                        <button id="exportProjectBtn" class="btn btn-secondary">üì§ Eksporter prosjekt</button>
                        <button id="importPackageBtn" class="btn btn-secondary">üì• Importer pakke</button>
                        <button id="printAllPackagesBtn" class="btn btn-success">üìÑ Skriv ut alle pakker</button>
                        <button id="newPackageBtn" class="btn btn-primary">+ Ny pakke</button>
                    </div>
                </div>
                <div id="packagesList" class="packages-list"></div>
                <input type="file" id="importPackageFile" accept=".json" style="display: none;">
            </div>

            <!-- Package Details View -->
            <div id="packageDetailsView" class="view">
                <div class="section-header">
                    <button id="backToPackagesBtn" class="btn btn-secondary">‚Üê Tilbake til pakker</button>
                    <h2 id="packageTitle"></h2>
                    <div style="display: flex; gap: 10px;">
                        <button id="exportPackageBtn" class="btn btn-secondary">üì§ Eksporter pakke</button>
                        <button id="printReportBtn" class="btn btn-success">üìÑ Generer PDF-rapport</button>
                    </div>
                </div>

                <!-- Print Summary Section (hidden on screen, shown in print) -->
                <div id="printSummary" class="print-summary">
                    <h2>Inspeksjonsrapport - Sammendrag</h2>
                    <div id="summaryContent"></div>
                </div>
                
                <div class="package-comment-section">
                    <h3>Pakkekommentar</h3>
                    <textarea id="packageComment" rows="3" placeholder="Legg til en kommentar for denne pakken..."></textarea>
                    <button id="savePackageCommentBtn" class="btn btn-primary">Lagre kommentar</button>
                </div>

                <div class="section-header">
                    <h3>R√∏rseksjoner (ISO-tegninger)</h3>
                    <button id="newLineBtn" class="btn btn-primary">+ Legg til r√∏rseksjon</button>
                </div>
                
                <!-- Drag and Drop Zone -->
                <div id="pdfDropZone" class="pdf-drop-zone">
                    <div class="drop-zone-content">
                        <span class="drop-zone-icon">üìÑ</span>
                        <p class="drop-zone-text">Dra og slipp PDF-filer her</p>
                        <p class="drop-zone-subtext">eller klikk for √• velge filer</p>
                        <input type="file" id="pdfDropInput" accept=".pdf" multiple style="display: none;">
                    </div>
                </div>
                
                <div id="linesList" class="lines-list"></div>
            </div>
        </main>
    </div>

    <!-- Modal for New Project -->
    <div id="newProjectModal" class="modal">
        <div class="modal-content">
            <h2>Opprett nytt prosjekt</h2>
            <form id="newProjectForm">
                <div class="form-group">
                    <label for="projectNumber">Prosjektnummer*</label>
                    <input type="text" id="projectNumber" required placeholder="f.eks., PRJ-2025-001">
                </div>
                <div class="form-group">
                    <label for="customerName">Kundenavn*</label>
                    <input type="text" id="customerName" required placeholder="f.eks., Acme AS">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary cancel-btn">Avbryt</button>
                    <button type="submit" class="btn btn-primary">Opprett</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Edit Project -->
    <div id="editProjectModal" class="modal">
        <div class="modal-content">
            <h2>Rediger prosjekt</h2>
            <form id="editProjectForm">
                <div class="form-group">
                    <label for="editProjectNumber">Prosjektnummer*</label>
                    <input type="text" id="editProjectNumber" required>
                </div>
                <div class="form-group">
                    <label for="editCustomerName">Kundenavn*</label>
                    <input type="text" id="editCustomerName" required>
                </div>
                <div class="modal-actions">
                    <button type="button" id="deleteProjectBtn" class="btn btn-danger">Slett prosjekt</button>
                    <button type="button" class="btn btn-secondary cancel-btn">Avbryt</button>
                    <button type="submit" class="btn btn-primary">Lagre endringer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Edit Package -->
    <div id="editPackageModal" class="modal">
        <div class="modal-content">
            <h2>Rediger pakke</h2>
            <form id="editPackageForm">
                <div class="form-group">
                    <label for="editPackageName">Pakkenavn*</label>
                    <input type="text" id="editPackageName" required>
                </div>
                <div class="form-group">
                    <label for="editPipeType">Type r√∏r</label>
                    <select id="editPipeType">
                        <option value="">Velg type r√∏r...</option>
                        <option value="PVC">PVC</option>
                        <option value="PE">PE (Polyetylen)</option>
                        <option value="PP">PP (Polypropylen)</option>
                        <option value="Betong">Betong</option>
                        <option value="St√•l">St√•l</option>
                        <option value="St√∏pejern">St√∏pejern</option>
                        <option value="Keramikk">Keramikk</option>
                        <option value="GRP">GRP (Glassfiberarmert plast)</option>
                        <option value="Annet">Annet</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editLining">Lining</label>
                    <select id="editLining">
                        <option value="">Velg lining...</option>
                        <option value="Ingen">Ingen</option>
                        <option value="Epoxy">Epoxy</option>
                        <option value="Polyuretan">Polyuretan</option>
                        <option value="Polypropylen">Polypropylen (PP)</option>
                        <option value="CIPP">CIPP (Cured-in-place pipe)</option>
                        <option value="GRP-lining">GRP-lining</option>
                        <option value="PE-lining">PE-lining</option>
                        <option value="Sementbasert">Sementbasert</option>
                        <option value="Annet">Annet</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editPackageCommentInput">Kommentar</label>
                    <textarea id="editPackageCommentInput" rows="3"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary cancel-btn">Avbryt</button>
                    <button type="submit" class="btn btn-primary">Lagre endringer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for New Package -->
    <div id="newPackageModal" class="modal">
        <div class="modal-content">
            <h2>Opprett ny testpakke</h2>
            <div id="modalProjectInfo" class="modal-project-info"></div>
            <form id="newPackageForm">
                <div class="form-group">
                    <label for="packageName">Pakkenavn*</label>
                    <input type="text" id="packageName" required>
                </div>
                <div class="form-group">
                    <label for="pipeType">Type r√∏r</label>
                    <select id="pipeType">
                        <option value="">Velg type r√∏r...</option>
                        <option value="PVC">PVC</option>
                        <option value="PE">PE (Polyetylen)</option>
                        <option value="PP">PP (Polypropylen)</option>
                        <option value="Betong">Betong</option>
                        <option value="St√•l">St√•l</option>
                        <option value="St√∏pejern">St√∏pejern</option>
                        <option value="Keramikk">Keramikk</option>
                        <option value="GRP">GRP (Glassfiberarmert plast)</option>
                        <option value="Annet">Annet</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="lining">Lining</label>
                    <select id="lining">
                        <option value="">Velg lining...</option>
                        <option value="Ingen">Ingen</option>
                        <option value="Epoxy">Epoxy</option>
                        <option value="Polyuretan">Polyuretan</option>
                        <option value="Polypropylen">Polypropylen (PP)</option>
                        <option value="CIPP">CIPP (Cured-in-place pipe)</option>
                        <option value="GRP-lining">GRP-lining</option>
                        <option value="PE-lining">PE-lining</option>
                        <option value="Sementbasert">Sementbasert</option>
                        <option value="Annet">Annet</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="packageCommentInput">Kommentar</label>
                    <textarea id="packageCommentInput" rows="3"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary cancel-btn">Avbryt</button>
                    <button type="submit" class="btn btn-primary">Opprett</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Edit Line -->
    <div id="editLineModal" class="modal">
        <div class="modal-content">
            <h2>Rediger r√∏rseksjon</h2>
            <form id="editLineForm">
                <div class="form-group">
                    <label for="editLineName">Seksjonsnavn/ID*</label>
                    <input type="text" id="editLineName" required>
                </div>
                <div class="form-group">
                    <label for="editLineNumber">Seksjonsnummer</label>
                    <input type="number" id="editLineNumber">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary cancel-btn">Avbryt</button>
                    <button type="submit" class="btn btn-primary">Lagre endringer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for New Line/PDF -->
    <div id="newLineModal" class="modal">
        <div class="modal-content">
            <h2>Legg til r√∏rseksjon</h2>
            <form id="newLineForm">
                <div class="form-group">
                    <label for="lineName">Seksjonsnavn/ID*</label>
                    <input type="text" id="lineName" required placeholder="f.eks., Seksjon A-1, P&ID 100-1">
                </div>
                <div class="form-group">
                    <label for="lineNumber">Seksjonsnummer</label>
                    <input type="number" id="lineNumber" value="1">
                </div>
                <div class="form-group">
                    <label for="pdfFile">ISO-tegning (PDF)</label>
                    <input type="file" id="pdfFile" accept=".pdf">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary cancel-btn">Avbryt</button>
                    <button type="submit" class="btn btn-primary">Legg til</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for New Remark -->
    <div id="newRemarkModal" class="modal">
        <div class="modal-content">
            <h2>Legg til merknad</h2>
            <form id="newRemarkForm">
                <div class="form-group">
                    <label for="remarkImage">Bilde*</label>
                    <input type="file" id="remarkImage" accept="image/*" required>
                    <div id="imagePreview"></div>
                </div>
                <div class="form-group">
                    <label for="remarkComment">Kommentar</label>
                    <textarea id="remarkComment" rows="3" placeholder="Legg til en kommentar for denne merknaden..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary cancel-btn">Avbryt</button>
                    <button type="submit" class="btn btn-primary">Legg til</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Viewing/Editing Remark -->
    <div id="viewRemarkModal" class="modal">
        <div class="modal-content large">
            <h2>Merknadsdetaljer</h2>
            <div id="remarkImageView"></div>
            <div class="form-group">
                <label for="editRemarkComment">Kommentar</label>
                <textarea id="editRemarkComment" rows="3"></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" id="deleteRemarkBtn" class="btn btn-danger">Slett</button>
                <button type="button" class="btn btn-secondary close-btn">Lukk</button>
                <button type="button" id="saveRemarkCommentBtn" class="btn btn-primary">Lagre kommentar</button>
            </div>
        </div>
    </div>

    <!-- Modal for PDF Viewer -->
    <div id="pdfViewerModal" class="modal">
        <div class="modal-content pdf-viewer-modal">
            <div class="pdf-viewer-header">
                <h2 id="pdfViewerTitle">ISO-tegning</h2>
                <span id="pdfViewerCounter" class="pdf-counter"></span>
            </div>
            <div class="pdf-viewer-container">
                <button id="pdfPrevBtn" class="pdf-nav-btn pdf-prev" title="Forrige (‚Üê)">‚Äπ</button>
                <iframe id="pdfViewerFrame" class="pdf-viewer-frame"></iframe>
                <button id="pdfNextBtn" class="pdf-nav-btn pdf-next" title="Neste (‚Üí)">‚Ä∫</button>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary close-btn">Lukk</button>
            </div>
        </div>
    </div>

    <!-- Modal for Change Password -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <h2>Endre passord</h2>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label for="currentPassword">N√•v√¶rende passord*</label>
                    <input type="password" id="currentPassword" required>
                </div>
                <div class="form-group">
                    <label for="newPassword">Nytt passord*</label>
                    <input type="password" id="newPassword" required minlength="6">
                    <small style="color: #666;">Minimum 6 tegn</small>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Bekreft nytt passord*</label>
                    <input type="password" id="confirmPassword" required minlength="6">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary cancel-btn">Avbryt</button>
                    <button type="submit" class="btn btn-primary">Endre passord</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for OCR Configuration -->
    <div id="ocrConfigModal" class="modal">
        <div class="modal-content ocr-modal">
            <h2>Konfigurer OCR-omr√•der</h2>
            <p class="ocr-instructions">
                Marker to omr√•der p√• PDF-en ved √• klikke og dra:<br>
                <strong>1. Document ID-Code omr√•de (bl√•tt)</strong><br>
                <strong>2. Sheet nummer omr√•de (gr√∏nt)</strong>
            </p>
            <div id="ocrCanvasContainer" class="ocr-canvas-container">
                <canvas id="ocrCanvas"></canvas>
            </div>
            <div class="ocr-status">
                <span id="ocrStatusText">Marker f√∏rste omr√•de (Document ID-Code)</span>
            </div>
            <div class="modal-actions">
                <button type="button" id="ocrResetBtn" class="btn btn-secondary">Tilbakestill omr√•der</button>
                <button type="button" id="ocrSkipBtn" class="btn btn-secondary">Hopp over OCR</button>
                <button type="button" id="ocrSaveBtn" class="btn btn-primary" disabled>Lagre og fortsett</button>
            </div>
        </div>
    </div>

    <!-- Modal for Settings -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2>‚öôÔ∏è Innstillinger</h2>
            
            <div class="settings-section">
                <h3>üîë Endre passord</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    Endre ditt passord for √• holde kontoen sikker
                </p>
                <button type="button" id="changePasswordBtnInSettings" class="btn btn-primary">Endre passord</button>
            </div>

            <div class="settings-section" style="border-top: 1px solid #e0e0e0; padding-top: 20px;">
                <h3>üö™ Logg ut</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    Logg ut av systemet
                </p>
                <button type="button" id="logoutBtnInSettings" class="btn btn-secondary">Logg ut</button>
            </div>

            <div class="settings-section" style="border-top: 1px solid #e0e0e0; padding-top: 20px;">
                <h3>‚ö†Ô∏è Resett data</h3>
                <p style="color: #c33; font-size: 14px; margin-bottom: 15px;">
                    <strong>ADVARSEL:</strong> Dette vil permanent slette alle prosjekter, pakker, PDF-er og bilder. Denne handlingen kan ikke angres!
                </p>
                <button type="button" id="resetDataBtn" class="btn btn-danger">Resett alle data</button>
            </div>

            <div class="modal-actions" style="margin-top: 30px;">
                <button type="button" class="btn btn-secondary close-btn">Lukk</button>
            </div>
        </div>
    </div>

    <!-- Modal for Reset Data Confirmation -->
    <div id="resetDataModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #c33;">‚ö†Ô∏è Bekreft sletting av alle data</h2>
            <p style="margin: 20px 0; font-size: 16px;">
                Du er i ferd med √• <strong>permanent slette</strong> alle data i systemet. Dette inkluderer:
            </p>
            <ul style="margin: 20px 0; padding-left: 30px; color: #666;">
                <li>Alle prosjekter</li>
                <li>Alle testpakker</li>
                <li>Alle PDF-filer</li>
                <li>Alle bilder og merknader</li>
            </ul>
            <p style="color: #c33; font-weight: bold; margin: 20px 0;">
                Denne handlingen kan IKKE angres!
            </p>
            <form id="resetDataForm">
                <div class="form-group">
                    <label for="resetConfirmText">Skriv <strong>SLETT ALT</strong> for √• bekrefte*</label>
                    <input type="text" id="resetConfirmText" required placeholder="Skriv SLETT ALT">
                </div>
                <div class="form-group">
                    <label for="resetPassword">Ditt passord*</label>
                    <input type="password" id="resetPassword" required placeholder="Skriv inn passordet ditt">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary cancel-btn">Avbryt</button>
                    <button type="submit" class="btn btn-danger">Slett alle data</button>
                </div>
            </form>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
